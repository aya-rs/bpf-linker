name: LLVM

on:
  workflow_call:
    outputs:
      artifact-ref:
        value: ${{ jobs.llvm.outputs.artifact-ref }}

permissions:
  contents: read
  packages: write

jobs:
  llvm:
    runs-on: ubuntu-22.04
    name: llvm
    outputs:
      artifact-ref: ${{ steps.artifact.outputs.ref }}
    steps:
      - id: ls-remote
        run: |
          set -euxo pipefail
          value=$(git ls-remote https://github.com/aya-rs/llvm-project.git refs/heads/rustc/21.1-2025-08-01 | cut -f1)
          echo "sha=$value" >> "$GITHUB_OUTPUT"

      - id: artifact
        run: |
          set -euxo pipefail
          echo "ref=ghcr.io/${{ github.repository }}-llvm:llvm-${{ steps.ls-remote.outputs.sha }}-1" >> "$GITHUB_OUTPUT"

      - uses: oras-project/setup-oras@v1

      - name: Login to ghcr.io
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euxo pipefail
          oras login ghcr.io --username "${{ github.actor }}" --password-stdin <<< "$GH_TOKEN"

      - name: Download LLVM artifact
        id: artifact-restore
        continue-on-error: true
        run: |
          set -euxo pipefail
          oras pull "${{ steps.artifact.outputs.ref }}"
          mkdir -p llvm-install
          tar --zstd -xf llvm-install.tar.zst -C llvm-install
          rm -f llvm-install.tar.zst

      - uses: actions/checkout@v6
        if: steps.artifact-restore.outcome != 'success'

      - uses: dtolnay/rust-toolchain@stable
        if: steps.artifact-restore.outcome != 'success'

      - name: Install Tools
        if: steps.artifact-restore.outcome != 'success'
        run: |
          set -euxo pipefail
          wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | \
            gpg --dearmor - | \
            sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null
          echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ jammy main' | \
            sudo tee /etc/apt/sources.list.d/kitware.list >/dev/null

          sudo apt update
          sudo apt -y install cmake ninja-build clang lld

      - name: Checkout LLVM Source
        if: steps.artifact-restore.outcome != 'success'
        uses: actions/checkout@v6
        with:
          repository: aya-rs/llvm-project
          ref: ${{ steps.ls-remote.outputs.sha }}
          path: llvm-project

      - name: Build LLVM
        if: steps.artifact-restore.outcome != 'success'
        run: |
          set -euxo pipefail
          cargo xtask build-llvm \
            --src-dir llvm-project \
            --build-dir llvm-build \
            --install-prefix "${{ github.workspace }}/llvm-install"

      - name: Package LLVM artifact
        if: steps.artifact-restore.outcome != 'success'
        run: |
          set -euxo pipefail
          tar --zstd -C llvm-install -cf llvm-install.tar.zst .

      - name: Publish LLVM OCI artifact
        if: steps.artifact-restore.outcome != 'success'
        run: |
          set -euxo pipefail
          oras push "${{ steps.artifact.outputs.ref }}" \
            --artifact-type application/vnd.aya.llvm.install \
            llvm-install.tar.zst:application/vnd.aya.llvm.install.layer.v1.tar+zstd
