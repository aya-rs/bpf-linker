name: LLVM

on:
  workflow_call:
    outputs:
      cache-key:
        value: ${{ jobs.llvm.outputs.cache-key }}

jobs:
  llvm:
    runs-on: ubuntu-22.04
    name: llvm
    outputs:
      cache-key: ${{ steps.cache-key.outputs.cache-key }}
    steps:
      - id: ls-remote
        run: |
          set -euxo pipefail
          value=$(git ls-remote https://github.com/aya-rs/llvm-project.git refs/heads/rustc/21.1-2025-08-01 | cut -f1)
          echo "sha=$value" >> "$GITHUB_OUTPUT"

      - id: cache-key
        run: echo "cache-key=llvm-${{ steps.ls-remote.outputs.sha }}-1" >> "$GITHUB_OUTPUT"

      - name: Cache
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: llvm-install
          key: ${{ steps.cache-key.outputs.cache-key }}
          lookup-only: true

      - uses: actions/checkout@v5
        if: steps.cache-llvm.outputs.cache-hit != 'true'

      - uses: dtolnay/rust-toolchain@stable
        if: steps.cache-llvm.outputs.cache-hit != 'true'

      - name: Install Tools
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          set -euxo pipefail
          wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | \
            gpg --dearmor - | \
            sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null
          echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ jammy main' | \
            sudo tee /etc/apt/sources.list.d/kitware.list >/dev/null

          sudo apt update
          sudo apt -y install cmake ninja-build clang lld

      - name: Checkout LLVM Source
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        uses: actions/checkout@v5
        with:
          repository: aya-rs/llvm-project
          ref: ${{ steps.ls-remote.outputs.sha }}
          path: llvm-project

      - name: Build LLVM
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cargo xtask llvm build \
            --src-dir llvm-project \
            --install-prefix "${{ github.workspace }}/llvm-install"
